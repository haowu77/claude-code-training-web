# 项目记忆文档示例

> 这是一个完整的 CLAUDE.md 示例，展示了如何组织项目知识

---

## 项目概述

这是一个使用 React + TypeScript 构建的现代 Web 应用，采用 Next.js 框架。

**关键信息**:
- **项目名称**: MyApp
- **版本**: 2.0.0
- **开始日期**: 2025-01-15
- **团队规模**: 5人开发团队

---

## 技术栈

### 前端
- **Framework**: Next.js 14.0 (App Router)
- **Language**: TypeScript 5.0
- **UI Library**: React 18.2
- **Styling**: Tailwind CSS 3.3
- **State Management**: Zustand
- **Form Handling**: React Hook Form + Zod
- **HTTP Client**: Axios

### 后端
- **Runtime**: Node.js 18+
- **Database**: PostgreSQL 15
- **ORM**: Prisma 5.0
- **Authentication**: NextAuth.js v5
- **API**: Next.js API Routes + tRPC

### 开发工具
- **Package Manager**: pnpm
- **Linting**: ESLint + Prettier
- **Testing**: Vitest + Playwright
- **CI/CD**: GitHub Actions
- **Deployment**: Vercel

---

## 编码标准

### TypeScript/JavaScript

#### 基本规则
```typescript
// ✅ 好的做法
const userName = 'John Doe'
const userAge: number = 30

// ❌ 避免
var userName = 'John Doe'  // 不使用 var
const userAge = 30  // 应添加类型注解
```

#### 类型定义
- 优先使用 `interface` 定义对象类型
- 使用 `type` 定义联合类型、交叉类型、工具类型
- 避免使用 `any`，使用 `unknown` 替代
- 导出所有公共接口

```typescript
// ✅ 好的做法
interface User {
  id: string
  name: string
  email: string
  createdAt: Date
}

type UserRole = 'admin' | 'user' | 'guest'

// ❌ 避免
interface User {
  id: any  // 不要使用 any
  data: object  // 太宽泛
}
```

#### 函数签名
```typescript
// ✅ 好的做法
async function fetchUser(id: string): Promise<User> {
  // ...
}

// ❌ 避免
async function fetchUser(id: any): Promise<any> {
  // ...
}
```

### React 组件

#### 组件结构
```typescript
// ✅ 好的做法 - 函数组件
interface UserProfileProps {
  userId: string
  onUpdate?: (user: User) => void
}

export function UserProfile({ userId, onUpdate }: UserProfileProps) {
  // Hooks 在顶部
  const [user, setUser] = useState<User | null>(null)
  const [loading, setLoading] = useState(true)

  // useEffect
  useEffect(() => {
    fetchUser(userId).then(setUser)
  }, [userId])

  // 早期返回
  if (loading) return <LoadingSpinner />
  if (!user) return <NotFound />

  // 主渲染
  return (
    <div className="user-profile">
      {/* ... */}
    </div>
  )
}
```

#### 命名约定
- 组件文件：`PascalCase.tsx` (例: `UserProfile.tsx`)
- Hooks：`camelCase.ts` 以 `use` 开头 (例: `useAuth.ts`)
- 工具函数：`camelCase.ts` (例: `formatDate.ts`)
- 常量：`UPPER_SNAKE_CASE` (例: `API_BASE_URL`)
- 类型/接口：`PascalCase` (例: `UserProfile`)

### CSS/Styling

#### Tailwind 使用
```tsx
// ✅ 好的做法
<div className="flex items-center justify-between p-4 bg-white rounded-lg shadow-sm">
  <h2 className="text-lg font-semibold text-gray-900">Title</h2>
  <button className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
    Action
  </button>
</div>

// ❌ 避免
<div style={{ display: 'flex', padding: '16px' }}>  // 不要用内联样式
  {/* ... */}
</div>
```

#### CSS 模块（当需要时）
```typescript
// UserProfile.module.css
.container {
  @apply flex flex-col gap-4 p-6;
}

.header {
  @apply text-2xl font-bold text-gray-900;
}

// UserProfile.tsx
import styles from './UserProfile.module.css'

export function UserProfile() {
  return <div className={styles.container}>...</div>
}
```

### 导入顺序

```typescript
// 1. React 和 Next.js
import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'

// 2. 第三方库
import { z } from 'zod'
import { useForm } from 'react-hook-form'

// 3. 内部模块（按路径深度）
import { Button } from '@/components/ui/button'
import { useAuth } from '@/hooks/useAuth'
import { formatDate } from '@/lib/utils'

// 4. 类型导入（分组在最后）
import type { User } from '@/types'
import type { FormData } from './types'

// 5. 样式和资源
import styles from './Component.module.css'
import './Component.css'
```

---

## 项目结构

```
app/
  ├── (auth)/              # 认证相关页面（路由组）
  │   ├── login/
  │   └── register/
  ├── (dashboard)/         # Dashboard 页面（路由组）
  │   ├── page.tsx
  │   ├── users/
  │   └── settings/
  ├── api/                 # API Routes
  │   ├── auth/
  │   ├── users/
  │   └── trpc/
  ├── layout.tsx           # 根布局
  ├── page.tsx             # 首页
  └── error.tsx            # 错误页面

components/
  ├── ui/                  # 基础 UI 组件
  │   ├── button.tsx
  │   ├── input.tsx
  │   └── modal.tsx
  └── features/            # 功能组件
      ├── auth/
      ├── user/
      └── dashboard/

lib/
  ├── db.ts                # Prisma 客户端
  ├── auth.ts              # 认证逻辑
  ├── trpc.ts              # tRPC 配置
  ├── utils.ts             # 工具函数
  └── validations.ts       # Zod schemas

hooks/
  ├── useAuth.ts           # 认证 Hook
  ├── useUser.ts           # 用户数据 Hook
  └── useDebounce.ts       # 通用 Hooks

types/
  ├── index.ts             # 公共类型
  ├── api.ts               # API 类型
  └── database.ts          # 数据库类型

prisma/
  ├── schema.prisma        # 数据库 schema
  └── migrations/          # 迁移文件（不要手动修改）

public/
  ├── images/
  ├── icons/
  └── fonts/
```

---

## 不应该修改的文件

⚠️ **禁止修改**:
- `.env*` 文件（包含敏感密钥）
- `prisma/migrations/*`（数据库迁移历史）
- `node_modules/`（依赖包）
- `package-lock.json` 或 `yarn.lock`（使用 pnpm-lock.yaml）
- `.next/`（构建输出）
- `public/assets/design-system/`（设计团队管理）

⚠️ **谨慎修改**（需要审查）:
- `package.json`（依赖更新需团队讨论）
- `tsconfig.json`（TypeScript 配置）
- `next.config.js`（Next.js 配置）
- `tailwind.config.ts`（Tailwind 配置）
- `prisma/schema.prisma`（数据库 schema 更改需迁移）

---

## API 设计规范

### RESTful API 约定

#### 路由命名
```
GET    /api/users           # 列表
GET    /api/users/:id       # 详情
POST   /api/users           # 创建
PATCH  /api/users/:id       # 更新
DELETE /api/users/:id       # 删除
```

#### 响应格式
```typescript
// 成功响应
{
  "data": { ... },
  "meta": {
    "page": 1,
    "limit": 20,
    "total": 100
  }
}

// 错误响应
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid email format",
    "details": { ... }
  }
}
```

#### API Route 模板
```typescript
// app/api/users/route.ts
import { NextResponse } from 'next/server'
import { auth } from '@/lib/auth'
import { db } from '@/lib/db'

export async function GET(request: Request) {
  try {
    // 1. 认证
    const session = await auth()
    if (!session) {
      return NextResponse.json(
        { error: { code: 'UNAUTHORIZED', message: 'Authentication required' } },
        { status: 401 }
      )
    }

    // 2. 权限检查
    if (!session.user.roles.includes('admin')) {
      return NextResponse.json(
        { error: { code: 'FORBIDDEN', message: 'Insufficient permissions' } },
        { status: 403 }
      )
    }

    // 3. 业务逻辑
    const users = await db.user.findMany({
      select: {
        id: true,
        name: true,
        email: true,
        createdAt: true,
      },
    })

    // 4. 返回响应
    return NextResponse.json({ data: users })
  } catch (error) {
    console.error('[API Error]:', error)
    return NextResponse.json(
      { error: { code: 'INTERNAL_ERROR', message: 'An error occurred' } },
      { status: 500 }
    )
  }
}
```

---

## 测试规范

### 测试结构
```
src/
  components/
    UserProfile.tsx
    UserProfile.test.tsx      # 组件测试
  lib/
    utils.ts
    utils.test.ts             # 单元测试
  hooks/
    useAuth.ts
    useAuth.test.ts           # Hook 测试

e2e/
  auth.spec.ts                # E2E 测试
  dashboard.spec.ts
```

### 测试模板

#### 组件测试
```typescript
// UserProfile.test.tsx
import { render, screen, waitFor } from '@testing-library/react'
import { UserProfile } from './UserProfile'

describe('UserProfile', () => {
  it('should render user information', async () => {
    const mockUser = {
      id: '1',
      name: 'John Doe',
      email: 'john@example.com',
    }

    render(<UserProfile userId="1" />)

    await waitFor(() => {
      expect(screen.getByText(mockUser.name)).toBeInTheDocument()
      expect(screen.getByText(mockUser.email)).toBeInTheDocument()
    })
  })

  it('should handle loading state', () => {
    render(<UserProfile userId="1" />)
    expect(screen.getByTestId('loading-spinner')).toBeInTheDocument()
  })
})
```

### 测试覆盖率目标
- **单元测试**: 80%+
- **集成测试**: 60%+
- **E2E 测试**: 关键用户流程

### 测试命名约定
```typescript
describe('ComponentName', () => {
  it('should do something when condition', () => {
    // ...
  })

  it('should throw error when invalid input', () => {
    // ...
  })
})
```

---

## Git 工作流

### 分支策略
- `main` - 生产环境，受保护
- `develop` - 开发环境
- `feature/*` - 新功能分支
- `fix/*` - Bug 修复分支
- `hotfix/*` - 紧急修复分支
- `chore/*` - 维护任务分支

### 分支命名
```bash
feature/user-authentication
fix/login-redirect-issue
hotfix/critical-security-patch
chore/update-dependencies
```

### Commit 规范

遵循 [Conventional Commits](https://www.conventionalcommits.org/)：

```bash
<type>(<scope>): <subject>

<body>

<footer>
```

**类型 (Type)**:
- `feat`: 新功能
- `fix`: Bug 修复
- `docs`: 文档更新
- `style`: 代码格式（不影响功能）
- `refactor`: 重构
- `perf`: 性能优化
- `test`: 测试相关
- `chore`: 构建/工具相关

**示例**:
```bash
feat(auth): add JWT refresh token mechanism

- Implement refresh token generation
- Add token rotation logic
- Update authentication middleware
- Add tests for token refresh flow

Closes #123
```

### PR 规范

#### PR 标题
```
feat(scope): brief description
fix(scope): brief description
```

#### PR 描述模板
```markdown
## 概述
[简要描述这个 PR 的目的]

## 更改
- [更改 1]
- [更改 2]
- [更改 3]

## 测试
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] E2E 测试通过（如适用）
- [ ] 手动测试完成

## 截图/录屏
[如果是 UI 更改，添加截图或录屏]

## 相关 Issue
Closes #xxx
Relates to #yyy

## 检查清单
- [ ] 代码遵循项目风格指南
- [ ] 添加了必要的测试
- [ ] 更新了相关文档
- [ ] 没有破坏性更改（或已在描述中说明）
- [ ] 已通过 lint 检查
- [ ] 已通过所有测试
```

### Commit 前检查

运行以下命令确保代码质量：
```bash
pnpm lint         # ESLint 检查
pnpm format       # Prettier 格式化
pnpm type-check   # TypeScript 类型检查
pnpm test         # 运行测试
pnpm build        # 构建检查
```

---

## 性能要求

### Core Web Vitals 目标
- **LCP (Largest Contentful Paint)**: < 2.5s
- **FID (First Input Delay)**: < 100ms
- **CLS (Cumulative Layout Shift)**: < 0.1

### 图片优化
- 使用 Next.js `Image` 组件
- 支持 WebP 格式
- 使用适当的尺寸和质量设置
- 实现懒加载

```tsx
import Image from 'next/image'

<Image
  src="/images/hero.jpg"
  alt="Hero image"
  width={1200}
  height={600}
  priority  // 首屏图片
  placeholder="blur"
/>
```

### 代码分割
- 使用动态导入减少初始包大小
- 懒加载非关键组件

```typescript
// ✅ 好的做法
const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <LoadingSpinner />,
})

// ❌ 避免
import { HeavyComponent } from './HeavyComponent'  // 增加初始包大小
```

### 缓存策略
- API 响应使用适当的缓存头
- 使用 React Query/SWR 处理数据缓存
- 实现乐观更新

---

## 安全要求

### 认证和授权
- 所有 API 路由需要认证
- 使用基于角色的访问控制 (RBAC)
- 实现 CSRF 保护
- 使用安全的会话管理

### 数据验证
```typescript
// 使用 Zod 进行输入验证
import { z } from 'zod'

const userSchema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
  name: z.string().min(2).max(50),
})

// API 中使用
const result = userSchema.safeParse(data)
if (!result.success) {
  return NextResponse.json(
    { error: { code: 'VALIDATION_ERROR', details: result.error } },
    { status: 400 }
  )
}
```

### 敏感数据处理
- 密码使用 bcrypt 哈希
- 敏感数据加密存储
- 不在日志中记录敏感信息
- 使用环境变量存储密钥

### 依赖安全
```bash
# 定期检查漏洞
pnpm audit

# 更新依赖
pnpm update

# 使用 dependabot 自动更新
```

---

## 环境变量

### 必需的环境变量

```bash
# 数据库
DATABASE_URL="postgresql://user:password@localhost:5432/myapp"

# 认证
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-key"  # 生产环境使用强密钥

# OAuth Providers（如使用）
GOOGLE_CLIENT_ID=""
GOOGLE_CLIENT_SECRET=""
GITHUB_CLIENT_ID=""
GITHUB_CLIENT_SECRET=""

# API 密钥（如使用）
STRIPE_SECRET_KEY=""
SENDGRID_API_KEY=""

# 应用配置
NEXT_PUBLIC_APP_URL="http://localhost:3000"
```

### 环境文件
- `.env` - 默认环境变量（提交到版本控制，不包含敏感信息）
- `.env.local` - 本地开发（不提交）
- `.env.production` - 生产环境（不提交）

---

## 部署流程

### Vercel 部署
1. 连接 GitHub 仓库
2. 配置环境变量
3. 自动部署流程：
   - `main` 分支 → 生产环境
   - `develop` 分支 → 预览环境
   - PR → 预览部署

### 部署前检查清单
- [ ] 所有测试通过
- [ ] 构建成功
- [ ] 环境变量已配置
- [ ] 数据库迁移已运行
- [ ] 性能指标达标
- [ ] 安全扫描通过

---

## 常见问题

### Q: 如何添加新的 API 端点？
1. 创建 `app/api/your-endpoint/route.ts`
2. 实现 HTTP 方法 (GET, POST, etc.)
3. 添加认证和验证
4. 编写测试
5. 更新 API 文档

### Q: 如何添加新的数据库表？
1. 修改 `prisma/schema.prisma`
2. 运行 `pnpm prisma migrate dev --name description`
3. 生成 Prisma Client: `pnpm prisma generate`
4. 更新相关类型

### Q: 如何处理敏感数据？
- 使用环境变量
- 不提交 `.env.local` 到版本控制
- 使用 Vercel/Secrets Manager 管理生产环境密钥
- 实现数据加密

---

## 团队协作

### 代码审查指南
- 每个 PR 至少需要 1 个审查批准
- 审查关注点：
  - 代码质量和可读性
  - 测试覆盖
  - 性能影响
  - 安全问题
  - 遵循项目规范

### 沟通渠道
- Slack: `#dev-team` - 日常开发讨论
- GitHub Issues - Bug 报告和功能请求
- GitHub Discussions - 架构讨论
- 每周会议 - 周五下午 2:00

---

## 资源链接

### 官方文档
- [Next.js 文档](https://nextjs.org/docs)
- [React 文档](https://react.dev/)
- [TypeScript 文档](https://www.typescriptlang.org/docs/)
- [Prisma 文档](https://www.prisma.io/docs/)
- [Tailwind CSS 文档](https://tailwindcss.com/docs)

### 内部资源
- 设计系统: [Figma 链接]
- API 文档: `/docs/api`
- 架构图: `/docs/architecture.md`
- 数据库 Schema: `/docs/database.md`

---

**最后更新**: 2025-12-02
**维护者**: 开发团队
**反馈**: 在 Slack #dev-team 频道或创建 GitHub Issue
